name: Push

on:
  push:
    branches:
      - main

jobs:
  push:
    name: Push
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: sh
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout codebase
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1
      - name: Login to Amazon ECR
        uses: docker/login-action@v3
        with:
          ecr: true
          logout: true
          registry: 976750617193.dkr.ecr.ap-south-1.amazonaws.com
      - name: Checkout
        uses: actions/checkout@v4
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: 976750617193.dkr.ecr.ap-south-1.amazonaws.com/wecoach-mailer-service
          tags: type=sha
      - name: Build
        run: docker image build --file build/Dockerfile --tag ${{ steps.meta.outputs.tags }} .
      - name: Push
        run: docker image push ${{ steps.meta.outputs.tags }}
